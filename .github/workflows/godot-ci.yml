################################################################################
# Godot CI/CD Workflow for Multi-Platform Export
#
# This workflow automatically builds and releases your Godot game for multiple
# platforms whenever code is pushed or PR'd to dev (canary) or main (stable).
#
# Supported Platforms:
#   - Windows Desktop
#   - Linux/X11
#   - macOS (universal binary, unsigned)
#   - Web/HTML5
#
# Release Channels:
#   - Canary: Auto-published on push/PR to 'dev' branch
#   - Stable: Auto-published on push/PR to 'main' branch
#
# Version Format:
#   - Canary: v0.0.1-canary.{run_number}
#   - Stable: v0.0.1 (increment manually in this file)
################################################################################

name: Godot CI - Multi-Platform Export

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

# Environment variables used across all jobs
env:
  GODOT_VERSION: 4.3
  # Update these versions as you release
  STABLE_VERSION: "0.0.1"
  CANARY_VERSION: "0.0.1-canary.${{ github.run_number }}"
  PROJECT_NAME: "robots-zombies-ghosts"

jobs:
  #############################################################################
  # WINDOWS EXPORT JOB
  #############################################################################
  export-windows:
    name: Windows Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:${{ github.event.repository.default_branch == 'main' && '4.3' || '4.3' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build Windows
        run: |
          mkdir -v -p build/windows
          godot --headless --verbose --export-release "Windows Desktop" build/windows/${{ env.PROJECT_NAME }}.exe

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows
          retention-days: 7

  #############################################################################
  # LINUX EXPORT JOB
  #############################################################################
  export-linux:
    name: Linux Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build Linux
        run: |
          mkdir -v -p build/linux
          godot --headless --verbose --export-release "Linux/X11" build/linux/${{ env.PROJECT_NAME }}.x86_64

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux
          retention-days: 7

  #############################################################################
  # macOS EXPORT JOB
  #############################################################################
  export-macos:
    name: macOS Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build macOS
        run: |
          # Debug: Check project settings
          echo "Checking project.godot for ETC2 ASTC setting:"
          grep -A 5 "\[rendering\]" project.godot || echo "No rendering section found"

          mkdir -v -p build/macos
          godot --headless --verbose --export-release "macOS" build/macos/${{ env.PROJECT_NAME }}.zip

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/macos
          retention-days: 7

  #############################################################################
  # WEB/HTML5 EXPORT JOB
  #############################################################################
  export-web:
    name: Web Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build Web
        run: |
          mkdir -v -p build/web
          godot --headless --verbose --export-release "Web" build/web/index.html

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  #############################################################################
  # CREATE GITHUB RELEASE
  #############################################################################
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [export-windows, export-linux, export-macos, export-web]
    # Only create releases on push (not PRs)
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Determine Version and Release Type
        id: version
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "version=v${{ env.STABLE_VERSION }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=Stable v${{ env.STABLE_VERSION }}" >> $GITHUB_OUTPUT
          else
            echo "version=v${{ env.CANARY_VERSION }}" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Canary v${{ env.CANARY_VERSION }}" >> $GITHUB_OUTPUT
          fi

      # Download all build artifacts
      - name: Download Windows Build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: releases/windows

      - name: Download Linux Build
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: releases/linux

      - name: Download macOS Build
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: releases/macos

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: releases/web

      # Create ZIP archives for each platform
      - name: Create Release Archives
        run: |
          cd releases
          zip -r ${{ env.PROJECT_NAME }}-windows-${{ steps.version.outputs.version }}.zip windows/
          zip -r ${{ env.PROJECT_NAME }}-linux-${{ steps.version.outputs.version }}.zip linux/
          zip -r ${{ env.PROJECT_NAME }}-macos-${{ steps.version.outputs.version }}.zip macos/
          zip -r ${{ env.PROJECT_NAME }}-web-${{ steps.version.outputs.version }}.zip web/

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: true
          files: |
            releases/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

################################################################################
# ADDITIONAL SETUP NOTES
################################################################################
#
# Incrementing Versions:
# ---------------------
# - For stable releases: Update STABLE_VERSION at the top of this file
# - For canary releases: Automatically increments with run_number
#
# GitHub Pages (Optional):
# -----------------------
# To deploy the web build to GitHub Pages, add a deployment job that
# publishes the web-build artifact to gh-pages branch.
################################################################################

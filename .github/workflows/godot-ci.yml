################################################################################
# Godot CI/CD Workflow for Multi-Platform Export
#
# This workflow automatically builds and releases your Godot game for multiple
# platforms whenever code is pushed or PR'd to dev (canary) or main (stable).
#
# Supported Platforms:
#   - Windows Desktop
#   - Linux/X11
#   - macOS (universal binary, unsigned)
#   - Web/HTML5
#   - Android (ARM64)
#
# Release Channels:
#   - Canary: Auto-published on push/PR to 'dev' branch
#   - Stable: Auto-published on push/PR to 'main' branch
#
# Version Format:
#   - Canary: v0.0.1-canary.{run_number}
#   - Stable: v0.0.1 (increment manually in this file)
################################################################################

name: Godot CI - Multi-Platform Export

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

# Environment variables used across all jobs
env:
  GODOT_VERSION: 4.3
  # Update these versions as you release
  STABLE_VERSION: "0.0.1"
  CANARY_VERSION: "0.0.1-canary.${{ github.run_number }}"
  PROJECT_NAME: "robots-zombies-ghosts"

jobs:
  #############################################################################
  # WINDOWS EXPORT JOB
  #############################################################################
  export-windows:
    name: Windows Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:${{ github.event.repository.default_branch == 'main' && '4.3' || '4.3' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build Windows
        run: |
          mkdir -v -p build/windows
          godot --headless --verbose --export-release "Windows Desktop" build/windows/${{ env.PROJECT_NAME }}.exe

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows
          retention-days: 7

  #############################################################################
  # LINUX EXPORT JOB
  #############################################################################
  export-linux:
    name: Linux Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build Linux
        run: |
          mkdir -v -p build/linux
          godot --headless --verbose --export-release "Linux/X11" build/linux/${{ env.PROJECT_NAME }}.x86_64

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux
          retention-days: 7

  #############################################################################
  # macOS EXPORT JOB
  #############################################################################
  export-macos:
    name: macOS Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build macOS
        run: |
          mkdir -v -p build/macos
          godot --headless --verbose --export-release "macOS" build/macos/${{ env.PROJECT_NAME }}.zip

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/macos
          retention-days: 7

  #############################################################################
  # WEB/HTML5 EXPORT JOB
  #############################################################################
  export-web:
    name: Web Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build Web
        run: |
          mkdir -v -p build/web
          godot --headless --verbose --export-release "Web" build/web/index.html

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  #############################################################################
  # ANDROID EXPORT JOB
  #############################################################################
  export-android:
    name: Android Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Setup Android SDK and Debug Keystore
        run: |
          # Ensure Android SDK directories exist
          mkdir -p ~/.android
          mkdir -p ~/.config/godot

          # Create a debug keystore
          keytool -genkeypair -v -keystore ~/.android/debug.keystore -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" 2>/dev/null || true

          # Configure Godot editor settings for Android
          cat > ~/.config/godot/editor_settings-4.tres << EOF
          [gd_resource type="EditorSettings" format=3]

          [resource]
          export/android/android_sdk_path = "/usr/lib/android-sdk"
          export/android/debug_keystore = "/root/.android/debug.keystore"
          export/android/debug_keystore_user = "androiddebugkey"
          export/android/debug_keystore_pass = "android"
          export/android/force_system_user = false
          export/android/shutdown_adb_on_exit = true
          export/android/one_click_deploy_clear_previous_install = false
          EOF

      # Setup Android keystore from secrets (if configured for release builds)
      # Uncomment these steps once you've added the required secrets
      # - name: Setup Android Keystore
      #   if: github.ref == 'refs/heads/main'
      #   run: |
      #     echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > /root/release.keystore
      #     echo "export GODOT_ANDROID_KEYSTORE_RELEASE_PATH=/root/release.keystore" >> $GITHUB_ENV
      #     echo "export GODOT_ANDROID_KEYSTORE_RELEASE_USER=${{ secrets.ANDROID_KEYSTORE_USER }}" >> $GITHUB_ENV
      #     echo "export GODOT_ANDROID_KEYSTORE_RELEASE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV

      - name: Build Android (Debug)
        run: |
          mkdir -v -p build/android
          godot --headless --verbose --export-debug "Android" build/android/${{ env.PROJECT_NAME }}.apk

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: build/android
          retention-days: 7

  #############################################################################
  # CREATE GITHUB RELEASE
  #############################################################################
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [export-windows, export-linux, export-macos, export-web, export-android]
    # Only create releases on push (not PRs)
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Determine Version and Release Type
        id: version
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "version=v${{ env.STABLE_VERSION }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=Stable v${{ env.STABLE_VERSION }}" >> $GITHUB_OUTPUT
          else
            echo "version=v${{ env.CANARY_VERSION }}" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Canary v${{ env.CANARY_VERSION }}" >> $GITHUB_OUTPUT
          fi

      # Download all build artifacts
      - name: Download Windows Build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: releases/windows

      - name: Download Linux Build
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: releases/linux

      - name: Download macOS Build
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: releases/macos

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: releases/web

      - name: Download Android Build
        uses: actions/download-artifact@v4
        with:
          name: android-build
          path: releases/android

      # Create ZIP archives for each platform
      - name: Create Release Archives
        run: |
          cd releases
          zip -r ${{ env.PROJECT_NAME }}-windows-${{ steps.version.outputs.version }}.zip windows/
          zip -r ${{ env.PROJECT_NAME }}-linux-${{ steps.version.outputs.version }}.zip linux/
          zip -r ${{ env.PROJECT_NAME }}-macos-${{ steps.version.outputs.version }}.zip macos/
          zip -r ${{ env.PROJECT_NAME }}-web-${{ steps.version.outputs.version }}.zip web/
          zip -r ${{ env.PROJECT_NAME }}-android-${{ steps.version.outputs.version }}.zip android/

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: true
          files: |
            releases/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

################################################################################
# ADDITIONAL SETUP NOTES
################################################################################
#
# Android Release Builds (Optional):
# ----------------------------------
# To create signed Android release builds, add these secrets to your repo:
# 1. ANDROID_KEYSTORE_BASE64: Your keystore file encoded as base64
#    Generate with: base64 -w 0 your-release-key.keystore
# 2. ANDROID_KEYSTORE_USER: Keystore alias
# 3. ANDROID_KEYSTORE_PASSWORD: Keystore password
#
# Then uncomment the "Setup Android Keystore" step in the export-android job.
#
# Incrementing Versions:
# ---------------------
# - For stable releases: Update STABLE_VERSION at the top of this file
# - For canary releases: Automatically increments with run_number
#
# GitHub Pages (Optional):
# -----------------------
# To deploy the web build to GitHub Pages, add a deployment job that
# publishes the web-build artifact to gh-pages branch.
################################################################################

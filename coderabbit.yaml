# =============================================================================
# CodeRabbit Configuration File - Schema v2 Compliant
# =============================================================================
# Schema Reference: https://coderabbit.ai/integrations/schema.v2.json
# Documentation: https://docs.coderabbit.ai/reference/configuration
# 
# This configuration maximizes code review capabilities with:
# - Full reviews on 'dev' and 'main' branches
# - Assertive review profile for thorough analysis
# - Jira integration for project "RGZ"
# - GitHub and Jira issue creation
# - CI/CD status checks and merge gates
# - Comprehensive security and quality tooling
# =============================================================================

# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# -----------------------------------------------------------------------------
# GLOBAL SETTINGS
# -----------------------------------------------------------------------------

# Language for review comments (ISO code)
language: "en-US"

# Custom tone instructions (MAX 250 characters per schema)
tone_instructions: "Be thorough. Identify edge cases, security issues, bad patterns, performance problems. Provide actionable recommendations with examples."

# Enable beta features for early access
early_access: true

# Enable free tier features
enable_free_tier: true

# -----------------------------------------------------------------------------
# REVIEWS CONFIGURATION
# -----------------------------------------------------------------------------
reviews:
  # ---------------------------------------------------------------------------
  # REVIEW PROFILE & WORKFLOW
  # ---------------------------------------------------------------------------
  
  # "assertive" - Thorough, detailed feedback including nitpicks
  profile: "assertive"
  
  # Mark PR as "Changes Requested" until issues resolved (enables merge blocking)
  request_changes_workflow: true

  # ---------------------------------------------------------------------------
  # SUMMARY & DOCUMENTATION FEATURES
  # ---------------------------------------------------------------------------
  
  high_level_summary: true
  high_level_summary_placeholder: "@coderabbitai summary"
  high_level_summary_in_walkthrough: true
  
  # Custom instructions for high-level summary (optional)
  high_level_summary_instructions: "Create concise summary with: 1) Main changes overview, 2) Security/performance implications, 3) Breaking changes if any"
  
  auto_title_placeholder: "@coderabbitai"
  auto_title_instructions: "Create concise, descriptive titles under 72 characters starting with an imperative verb"
  
  review_status: true
  commit_status: true
  fail_commit_status: false
  collapse_walkthrough: false
  changed_files_summary: true
  sequence_diagrams: true
  estimate_code_review_effort: true
  assess_linked_issues: true
  related_issues: true
  related_prs: true
  
  # Label suggestions
  suggested_labels: true
  auto_apply_labels: false
  
  # Custom labeling instructions
  labeling_instructions:
    - label: "security"
      instructions: "Apply when PR contains security-related changes, authentication, authorization, or data protection"
    - label: "performance"
      instructions: "Apply when PR optimizes performance, database queries, or resource usage"
    - label: "breaking-change"
      instructions: "Apply when PR introduces breaking changes to APIs or interfaces"
  
  # Reviewer suggestions
  suggested_reviewers: true
  auto_assign_reviewers: false
  
  in_progress_fortune: true
  poem: false
  abort_on_close: true
  disable_cache: false

  # ---------------------------------------------------------------------------
  # AUTO-REVIEW CONFIGURATION
  # ---------------------------------------------------------------------------
  auto_review:
    enabled: true
    auto_incremental_review: true
    drafts: false
    
    # TARGET BRANCHES - Only review PRs to these branches
    base_branches:
      - "dev"
      - "main"
    
    # Skip PRs with these keywords in title
    ignore_title_keywords:
      - "WIP"
      - "DO NOT MERGE"
      - "DRAFT"
      - "[skip review]"
      - "[skip ci]"
    
    # Label filtering
    labels:
      - "!wip"
      - "!no-review"
    
    # Skip PRs from bots
    ignore_usernames:
      - "dependabot[bot]"
      - "dependabot"
      - "renovate[bot]"
      - "renovate"
      - "github-actions[bot]"

  # ---------------------------------------------------------------------------
  # PATH FILTERS
  # ---------------------------------------------------------------------------
  path_filters:
    # Include source code
    - "src/**"
    - "lib/**"
    - "app/**"
    - "packages/**"
    
    # Exclude build artifacts
    - "!dist/**"
    - "!build/**"
    - "!out/**"
    - "!.next/**"
    
    # Exclude dependencies
    - "!node_modules/**"
    - "!vendor/**"
    - "!**/package-lock.json"
    - "!**/yarn.lock"
    - "!**/pnpm-lock.yaml"
    
    # Exclude generated code
    - "!**/__generated__/**"
    - "!**/generated/**"
    - "!**/*.generated.*"
    
    # Exclude media files
    - "!**/*.png"
    - "!**/*.jpg"
    - "!**/*.jpeg"
    - "!**/*.gif"
    - "!**/*.svg"
    - "!**/*.ico"
    
    # Exclude minified files
    - "!**/*.min.js"
    - "!**/*.min.css"
    - "!**/*.map"

  # ---------------------------------------------------------------------------
  # PATH-SPECIFIC REVIEW INSTRUCTIONS (MAX 20000 chars per instruction)
  # ---------------------------------------------------------------------------
  path_instructions:
    - path: "**/*.{js,jsx,ts,tsx}"
      instructions: |
        Focus on JavaScript/TypeScript quality:
        
        Edge Cases: null/undefined handling, empty arrays/objects, boundary conditions, async race conditions
        Bad Patterns: callback hell, unused variables, god functions, magic numbers, improper error handling, memory leaks
        Security: XSS vulnerabilities, prototype pollution, unsafe eval(), hardcoded credentials
        Performance: unnecessary re-renders, missing memoization, blocking operations, N+1 patterns
    
    - path: "**/*.py"
      instructions: |
        Review Python for: PEP 8 compliance, type hints, exception handling, context managers, security (SQL/command injection), performance optimizations
    
    - path: "**/api/**"
      instructions: |
        Security-focused API review: authentication/authorization on all endpoints, input validation, SQL injection prevention, rate limiting, proper error responses (no sensitive data leakage), CORS configuration
    
    - path: "**/{models,database,db,migrations}/**"
      instructions: |
        Database review: N+1 query prevention, index usage, transaction handling, connection pooling, migration safety, query performance
    
    - path: "**/{test,tests,__tests__,spec}/**"
      instructions: |
        Test review: edge case coverage, proper assertions, test isolation, mock/stub usage, clear descriptions, AAA pattern, no flaky patterns
    
    - path: "**/*.{yaml,yml,json,toml}"
      instructions: |
        Config review: no hardcoded secrets, environment-specific values externalized, schema validation, secure defaults
    
    - path: "**/Dockerfile*"
      instructions: |
        Dockerfile review: secure base images (pinned versions), multi-stage builds, no secrets in build args, non-root user, layer optimization

  # ---------------------------------------------------------------------------
  # FINISHING TOUCHES
  # ---------------------------------------------------------------------------
  finishing_touches:
    docstrings:
      enabled: true
    unit_tests:
      enabled: true

  # ---------------------------------------------------------------------------
  # PRE-MERGE CHECKS - Can block merges when mode is "error"
  # ---------------------------------------------------------------------------
  pre_merge_checks:
    # Docstring coverage
    docstrings:
      mode: "warning"
      threshold: 75
    
    # Title validation
    title:
      mode: "warning"
      requirements: "Title should start with an imperative verb, be under 72 characters, and be descriptive"
    
    # Description validation
    description:
      mode: "warning"
    
    # Linked issue assessment
    issue_assessment:
      mode: "warning"
    
    # Custom checks (MAX 5 checks, each name max 50 chars, instructions max 10000 chars)
    custom_checks:
      - name: "Security Review Gate"
        mode: "error"
        instructions: |
          CRITICAL SECURITY CHECK - Block merge if found:
          - Hardcoded secrets, API keys, passwords, tokens
          - SQL injection vulnerabilities
          - XSS vulnerabilities
          - Command injection risks
          - Insecure deserialization
          - Authentication/authorization bypasses
          - Sensitive data exposure in logs/responses
      
      - name: "Edge Case Analysis"
        mode: "warning"
        instructions: |
          Verify handling of: null/undefined/empty values, boundary conditions (min/max, empty collections), error states, concurrent access, network failures, invalid inputs
      
      - name: "Performance Review"
        mode: "warning"
        instructions: |
          Check: N+1 queries, unbounded loops/recursion, missing pagination, blocking I/O in async, memory leaks, inefficient algorithms
      
      - name: "Code Quality Standards"
        mode: "warning"
        instructions: |
          Verify: functions under 50 lines, max 4 nesting levels, meaningful names, proper error messages, no commented code, no TODOs without linked issues

  # ---------------------------------------------------------------------------
  # STATIC ANALYSIS TOOLS
  # ---------------------------------------------------------------------------
  tools:
    # JavaScript/TypeScript
    eslint:
      enabled: true
    biome:
      enabled: true
    oxc:
      enabled: true
    
    # Python
    ruff:
      enabled: true
    pylint:
      enabled: true
    flake8:
      enabled: true
    
    # Security scanners (CRITICAL)
    gitleaks:
      enabled: true
    semgrep:
      enabled: true
    osvScanner:
      enabled: true
    checkov:
      enabled: true
    brakeman:
      enabled: true
    
    # Infrastructure & DevOps
    hadolint:
      enabled: true
    actionlint:
      enabled: true
    circleci:
      enabled: true
    shellcheck:
      enabled: true
    
    # Other languages
    golangci-lint:
      enabled: true
    rubocop:
      enabled: true
    phpstan:
      enabled: true
      level: "default"
    detekt:
      enabled: true
    clippy:
      enabled: true
    swiftlint:
      enabled: true
    
    # Additional tools
    markdownlint:
      enabled: true
    yamllint:
      enabled: true
    sqlfluff:
      enabled: true
    
    # AST-based pattern matching
    ast-grep:
      essential_rules: true
      rule_dirs: []
      util_dirs: []
      packages: []
    
    # Grammar checker
    languagetool:
      enabled: true
      disabled_rules:
        - "EN_UNPAIRED_BRACKETS"
      disabled_categories:
        - "TYPOS"
        - "CASING"
    
    # GitHub Checks integration
    github-checks:
      enabled: true
      timeout_ms: 90000

# -----------------------------------------------------------------------------
# CHAT CONFIGURATION
# -----------------------------------------------------------------------------
chat:
  # Respond without requiring @coderabbitai mention
  auto_reply: true
  
  # Generate ASCII/emoji art
  art: false
  
  # Issue tracker integrations
  integrations:
    jira:
      usage: "enabled"
    linear:
      usage: "auto"

# -----------------------------------------------------------------------------
# KNOWLEDGE BASE CONFIGURATION
# -----------------------------------------------------------------------------
knowledge_base:
  # Don't opt out - allow learning
  opt_out: false
  
  # Web search
  web_search:
    enabled: true
  
  # Code guidelines
  code_guidelines:
    enabled: true
    filePatterns:
      - "**/.cursorrules"
      - "**/CODING_STANDARDS.md"
      - "**/STYLE_GUIDE.md"
      - ".github/copilot-instructions.md"
      - "**/CLAUDE.md"
      - "**/CONTRIBUTING.md"
  
  # Learnings scope
  learnings:
    scope: "auto"
  
  # Issues scope
  issues:
    scope: "auto"
  
  # JIRA INTEGRATION - Project RGZ
  jira:
    usage: "enabled"
    project_keys:
      - "RGZ"
  
  # Linear integration
  linear:
    usage: "auto"
    team_keys: []
  
  # Pull requests scope
  pull_requests:
    scope: "auto"

# -----------------------------------------------------------------------------
# CODE GENERATION CONFIGURATION
# -----------------------------------------------------------------------------
code_generation:
  # Docstring generation
  docstrings:
    language: "en-US"
    path_instructions:
      - path: "**/*.py"
        instructions: "Use Google-style docstrings with Args, Returns, and Raises sections"
      - path: "**/*.{js,ts}"
        instructions: "Use JSDoc format with @param, @returns, and @throws tags"
  
  # Unit test generation
  unit_tests:
    path_instructions:
      - path: "**/*.{js,jsx}"
        instructions: "Use Jest framework with describe/it blocks and expect assertions"
      - path: "**/*.{ts,tsx}"
        instructions: "Use Jest with TypeScript, include type assertions"
      - path: "**/*.py"
        instructions: "Use pytest framework with descriptive test function names"
